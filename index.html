<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Lotes (Online)</title>
    
    <!-- Bibliotecas de Estilo e React -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    
    <!-- FIREBASE SETUP (Módulo) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, query, orderBy, writeBatch 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAGOZjJ33KZIlBWmZ3v25EckcVCJU5PNxA",
            authDomain: "lotesc-3409d.firebaseapp.com",
            projectId: "lotesc-3409d",
            storageBucket: "lotesc-3409d.firebasestorage.app",
            messagingSenderId: "610707549267",
            appId: "1:610707549267:web:39dbe1e3c46089d40eaaa6",
            measurementId: "G-JCSGY55F5S"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.fb = { collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, query, orderBy, writeBatch };
        
        window.dbReady = true;
        window.dispatchEvent(new Event('db-ready'));
        console.log("Firebase Conectado!");
    </script>
    
    <!-- Estilos de Impressão -->
    <style>
        @media print {
            body { background-color: white; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            
            @page { size: A4 landscape; margin: 5mm; }

            #area-impressao-etiquetas {
                display: grid !important;
                grid-template-columns: repeat(5, 1fr);
                gap: 2mm;
                width: 100% !important;
                height: 100%;
                visibility: visible;
                position: absolute; top: 0; left: 0;
                background: white;
                z-index: 9999;
                padding: 2mm;
            }

            #area-impressao-relatorio {
                display: block !important;
                visibility: visible;
                width: 100%;
                position: absolute; top: 0; left: 0;
                padding: 10mm;
                background: white;
                z-index: 9999;
            }

            .label-card { 
                border: 1px solid #000; 
                height: 90mm; 
                display: flex; 
                flex-direction: column; 
                justify-content: space-between; 
                padding: 2px; 
                page-break-inside: avoid;
                overflow: hidden;
                box-sizing: border-box;
            }
            .label-header { border-bottom: 2px solid #000; display: flex; justify-content: space-around; padding-bottom: 2px; margin-bottom: 2px; }
            .header-col { display: flex; flex-direction: column; align-items: center; }
            .header-title { font-size: 8px; font-weight: 700; color: #555; text-transform: uppercase; }
            .header-value { font-size: 14px; font-weight: 900; color: #000; line-height: 1; text-transform: uppercase; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
            .label-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
            .label-text { font-family: 'Courier New', monospace; font-weight: bold; font-size: 18px; margin-top: 5px; }
            .label-footer { border-top: 1px dashed #000; padding-top: 4px; font-size: 9px; }
            .footer-title { background: #eee; text-align: center; font-weight: bold; margin-bottom: 2px; font-size: 8px; }
            .check-item { display: flex; align-items: center; gap: 4px; justify-content: center; font-weight: bold; }
            .check-box { width: 10px; height: 10px; border: 1px solid #000; display: inline-block; }
            .footer-inputs { display: flex; justify-content: space-between; margin-top: 4px; font-size: 7px; font-weight: bold; border-top: 1px dotted #ccc; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // Ícones
        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Plus: (props) => <Icon {...props} path={<React.Fragment><path d="M5 12h14"/><path d="M12 5v14"/></React.Fragment>} />,
            Printer: (props) => <Icon {...props} path={<React.Fragment><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></React.Fragment>} />,
            Package: (props) => <Icon {...props} path={<React.Fragment><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></React.Fragment>} />,
            ArrowRight: (props) => <Icon {...props} path={<React.Fragment><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></React.Fragment>} />,
            Trash2: (props) => <Icon {...props} path={<React.Fragment><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></React.Fragment>} />,
            Layers: (props) => <Icon {...props} path={<React.Fragment><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></React.Fragment>} />,
            FileText: (props) => <Icon {...props} path={<React.Fragment><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></React.Fragment>} />,
            Search: (props) => <Icon {...props} path={<React.Fragment><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></React.Fragment>} />,
            Clock: (props) => <Icon {...props} path={<React.Fragment><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></React.Fragment>} />,
            CheckSquare: (props) => <Icon {...props} path={<React.Fragment><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></React.Fragment>} />,
            AlertTriangle: (props) => <Icon {...props} path={<React.Fragment><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></React.Fragment>} />,
            Activity: (props) => <Icon {...props} path={<React.Fragment><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></React.Fragment>} />,
            Download: (props) => <Icon {...props} path={<React.Fragment><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></React.Fragment>} />,
            Code: (props) => <Icon {...props} path={<React.Fragment><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></React.Fragment>} />,
            X: (props) => <Icon {...props} path={<React.Fragment><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></React.Fragment>} />,
            Calendar: (props) => <Icon {...props} path={<React.Fragment><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></React.Fragment>} />,
            MoveRight: (props) => <Icon {...props} path={<React.Fragment><path d="M18 8L22 12L18 16"/><path d="M2 12H22"/></React.Fragment>} />,
            List: (props) => <Icon {...props} path={<React.Fragment><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></React.Fragment>} />
        };

        const LISTA_PADRAO = [
          "751-02 — SMB - GO", "751-05 — F RVD - GO", "751-06 — IPR - GO", "751-07 — F TRD - GO",
          "751-08 — F GYN - GO", "751-10 — F ANP - GO", "751-14 — F APG - GO",
          "751-18 — F CTL - GO", "751-24 — F GYN 02 - GO", "751-25 — F SEN - GO",
          "751-26 — GYN 05 - GO", "760-00 — F GYN 04 - GO",
          "752-00 — F PDR - GO", "759-00 — F PON - GO", "762-00 — F GYN 03 - GO",
          "783-00 — F QUI-GO"
        ];

        // Utils
        const formatDateToPTBR = (isoDate) => {
            if (!isoDate) return '';
            const [y, m, d] = isoDate.split('-');
            return `${d}/${m}/${y}`;
        };

        const getTodayISO = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // Componente QR Code
        const QRCodeImage = ({ text, size = 100 }) => {
            const canvasRef = useRef(null);
            useEffect(() => {
                if (window.QRious && canvasRef.current) {
                    new window.QRious({ element: canvasRef.current, value: text, size: size, level: 'M' });
                }
            }, [text, size]);
            return <canvas ref={canvasRef} width={size} height={size} style={{ width: '100%', height: 'auto' }} />;
        };

        // --- APP PRINCIPAL ---
        function App() {
            const [activeTab, setActiveTab] = useState('operacao');
            const [listaBases, setListaBases] = useState(LISTA_PADRAO);
            const [lotes, setLotes] = useState([]);
            const [dbConnected, setDbConnected] = useState(false);

            const [modoEntrada, setModoEntrada] = useState('scanner');
            const [novoLote, setNovoLote] = useState('');
            const [lotesMassa, setLotesMassa] = useState('');
            const [novaBase, setNovaBase] = useState('');
            const [novoPeriodo, setNovoPeriodo] = useState('Manhã'); 
            const loteInputRef = useRef(null);

            const [baseParaImpressao, setBaseParaImpressao] = useState('');
            const [periodoImpressao, setPeriodoImpressao] = useState('Todos');
            const [lotesParaImprimir, setLotesParaImprimir] = useState([]);
            const [selectedIds, setSelectedIds] = useState(new Set()); 
            const [dataImpressaoMassa, setDataImpressaoMassa] = useState(getTodayISO());

            const [filtroTexto, setFiltroTexto] = useState('');
            const [filtroBase, setFiltroBase] = useState('');
            const [filtroStatus, setFiltroStatus] = useState('todos');
            const [dataInicio, setDataInicio] = useState('');
            const [dataFim, setDataFim] = useState('');

            const [pendenteBuscaLote, setPendenteBuscaLote] = useState('');
            const [pendenteBuscaBase, setPendenteBuscaBase] = useState('');
            const [pendenteDataFiltro, setPendenteDataFiltro] = useState(''); 
            
            const [processadoBusca, setProcessadoBusca] = useState('');
            const [processadosDataFiltro, setProcessadosDataFiltro] = useState(getTodayISO());
            const [processadoBaseFiltro, setProcessadoBaseFiltro] = useState(''); 
            const [dataParaMover, setDataParaMover] = useState('');

            const [consultaTermo, setConsultaTermo] = useState('');
            const [now, setNow] = useState(Date.now());

            useEffect(() => {
                const iniciarConexao = () => {
                    if (window.db && window.fb) {
                        setDbConnected(true);
                        const q = window.fb.query(
                            window.fb.collection(window.db, "lotes"), 
                            window.fb.orderBy("timestampCriacao", "desc")
                        );
                        
                        const unsubscribe = window.fb.onSnapshot(q, (querySnapshot) => {
                            const lotesAtualizados = [];
                            querySnapshot.forEach((doc) => {
                                lotesAtualizados.push({ ...doc.data(), id: doc.id });
                            });
                            setLotes(lotesAtualizados);
                        }, (error) => {
                            console.error("Erro ao ler dados:", error);
                        });

                        return unsubscribe;
                    }
                };

                if (window.dbReady) {
                    const unsub = iniciarConexao();
                    return () => unsub && unsub();
                } else {
                    window.addEventListener('db-ready', iniciarConexao);
                    return () => window.removeEventListener('db-ready', iniciarConexao);
                }
            }, []);

            useEffect(() => {
                const interval = setInterval(() => setNow(Date.now()), 60000);
                return () => clearInterval(interval);
            }, []);

            const adicionarLote = async (e) => {
                e.preventDefault();
                const codigoFormatado = novoLote.trim().toUpperCase();

                if (!codigoFormatado) return alert("Digite o lote.");
                if ((codigoFormatado.match(/BR/g) || []).length > 1) {
                    alert("⚠️ ERRO DE LEITURA:\nForam detectados dois códigos 'BR' juntos.");
                    setNovoLote('');
                    if (loteInputRef.current) loteInputRef.current.focus();
                    return;
                }

                if (!novaBase.trim()) return alert("Selecione a base.");
                if (!dbConnected) return alert("Banco de dados não conectado!");

                const dataAtual = new Date();
                const novoItem = {
                    codigo: codigoFormatado,
                    status: 'pendente', 
                    baseSegmento: novaBase,
                    periodo: novoPeriodo,
                    timestampCriacao: dataAtual.getTime(),
                    dataCriacao: dataAtual.toLocaleDateString('pt-BR'),
                    horaCriacao: dataAtual.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                    historico: [{ status: 'CRIADO', data: dataAtual.toLocaleString('pt-BR'), detalhe: 'Entrada manual' }]
                };

                try {
                    await window.fb.addDoc(window.fb.collection(window.db, "lotes"), novoItem);
                    setNovoLote('');
                    if (loteInputRef.current) loteInputRef.current.focus();
                } catch (error) {
                    console.error("Erro ao salvar:", error);
                }
            };

            const adicionarLotesMassa = async () => {
                if (!lotesMassa.trim()) return alert("A lista está vazia.");
                if (!novaBase.trim()) return alert("Selecione a base.");
                if (!dbConnected) return alert("Banco de dados não conectado!");

                let codigos = lotesMassa
                    .split(/\r?\n/)
                    .map(c => c.trim().toUpperCase())
                    .filter(c => c !== '');
                
                codigos = codigos.filter(c => (c.match(/BR/g) || []).length <= 1);
                
                if (codigos.length === 0) return alert("Nenhum código válido encontrado.");

                if (!confirm(`Confirma a importação de ${codigos.length} lotes para a base ${novaBase}?`)) return;

                const dataAtual = new Date();
                const colecaoRef = window.fb.collection(window.db, "lotes");

                let count = 0;
                for (let cod of codigos) {
                    try {
                        const novoItem = {
                            codigo: cod,
                            status: 'pendente', 
                            baseSegmento: novaBase,
                            periodo: novoPeriodo, 
                            timestampCriacao: dataAtual.getTime(),
                            dataCriacao: dataAtual.toLocaleDateString('pt-BR'),
                            horaCriacao: dataAtual.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                            historico: [{ status: 'CRIADO', data: dataAtual.toLocaleString('pt-BR'), detalhe: 'Importação em massa' }]
                        };
                        await window.fb.addDoc(colecaoRef, novoItem);
                        count++;
                    } catch(e) { console.error(e); }
                }

                setLotesMassa('');
                setModoEntrada('scanner');
                alert(`${count} lotes importados com sucesso!`);
            };

            const mudarStatus = async (id, novoStatus) => {
                const loteAtual = lotes.find(l => l.id === id);
                if (!loteAtual) return;

                const novoHistorico = [
                    ...loteAtual.historico, 
                    { 
                        status: novoStatus.toUpperCase(), 
                        data: new Date().toLocaleString('pt-BR'), 
                        detalhe: 'Alteração de status'
                    }
                ];

                try {
                    await window.fb.updateDoc(window.fb.doc(window.db, "lotes", id), {
                        status: novoStatus,
                        historico: novoHistorico
                    });
                } catch (error) { console.error(error); }
            };

            const removerLote = async (id) => {
                const lote = lotes.find(l => l.id === id);
                if (!lote) return;

                if (lote.status === 'impressao') {
                    const senha = prompt("Item Processado! Digite a senha para excluir:");
                    if (senha !== "JT@2026") return alert("Senha incorreta!");
                } else {
                    if(!confirm('Excluir lote?')) return;
                }

                try {
                    await window.fb.deleteDoc(window.fb.doc(window.db, "lotes", id));
                } catch (error) { console.error(error); }
            };

            const toggleSelection = (id) => {
                const newSelection = new Set(selectedIds);
                if (newSelection.has(id)) newSelection.delete(id);
                else newSelection.add(id);
                setSelectedIds(newSelection);
            };

            const imprimirSelecionados = () => {
                if (selectedIds.size === 0) return alert("Selecione lotes.");
                setLotesParaImprimir(lotes.filter(l => selectedIds.has(l.id)));
                setTimeout(() => window.print(), 800);
            };

            const verificarAlerta10Horas = (timestampCriacao) => {
                return ((now - timestampCriacao) / (1000 * 60 * 60)) >= 10;
            };

            const prepararImpressaoDoDia = async () => {
                if (!baseParaImpressao) return alert("Selecione a base.");
                const dataFiltro = formatDateToPTBR(dataImpressaoMassa);

                if (periodoImpressao !== 'Todos') {
                    const itensPeriodo = lotes.filter(l => 
                        l.baseSegmento === baseParaImpressao &&
                        l.dataCriacao === dataFiltro &&
                        l.periodo === periodoImpressao
                    );
                    
                    if (itensPeriodo.length === 0) return alert("Nenhum item encontrado.");

                    const pendentesParaProcessar = itensPeriodo.filter(l => l.status === 'pendente');
                    if (pendentesParaProcessar.length > 0) {
                        const batch = window.fb.writeBatch(window.db);
                        const dataHora = new Date().toLocaleString('pt-BR');
                        pendentesParaProcessar.forEach(item => {
                            const docRef = window.fb.doc(window.db, "lotes", item.id);
                            batch.update(docRef, { status: 'impressao', historico: [...item.historico, { status: 'IMPRESSAO', data: dataHora, detalhe: 'Fechamento Período' }] });
                        });
                        await batch.commit();
                    }
                    setLotesParaImprimir(itensPeriodo);
                    setTimeout(() => window.print(), 800);
                } else {
                    const lotesDoDia = lotes.filter(l => l.baseSegmento === baseParaImpressao && l.dataCriacao === dataFiltro && l.status === 'impressao');
                    if (lotesDoDia.length === 0) return alert("Nenhum lote processado.");
                    setLotesParaImprimir(lotesDoDia);
                    setTimeout(() => window.print(), 800);
                }
            };

            const lotesFiltradosRelatorio = useMemo(() => {
                return lotes.filter(lote => {
                    const matchTexto = lote.codigo.includes(filtroTexto.toUpperCase());
                    const matchBase = filtroBase === "" || lote.baseSegmento === filtroBase;
                    const matchStatus = filtroStatus !== 'todos' ? lote.status === filtroStatus : true;
                    return matchTexto && matchBase && matchStatus;
                });
            }, [lotes, filtroTexto, filtroBase, filtroStatus]);

            const pendentes = lotes.filter(l => l.status === 'pendente');
            const agrupados = pendentes.reduce((acc, l) => {
                const b = l.baseSegmento || 'Geral';
                if (!acc[b]) acc[b] = [];
                acc[b].push(l);
                return acc;
            }, {});

            const processados = lotes.filter(l => l.dataCriacao === formatDateToPTBR(processadosDataFiltro) && l.status === 'impressao');

            return (
                <div className="min-h-screen bg-gray-100">
                    <div className="bg-slate-900 text-white p-4 flex justify-between items-center no-print">
                        <div className="flex items-center gap-3">
                            <Icons.Package className="text-indigo-400" />
                            <h1 className="text-xl font-bold">Sistema de Lotes</h1>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={()=>setActiveTab('operacao')} className={`px-4 py-2 rounded ${activeTab==='operacao'?'bg-indigo-600':'hover:bg-slate-800'}`}>Operação</button>
                            <button onClick={()=>setActiveTab('relatorio')} className={`px-4 py-2 rounded ${activeTab==='relatorio'?'bg-indigo-600':'hover:bg-slate-800'}`}>Relatórios</button>
                            <button onClick={()=>setActiveTab('consulta')} className={`px-4 py-2 rounded ${activeTab==='consulta'?'bg-indigo-600':'hover:bg-slate-800'}`}>Consulta</button>
                        </div>
                    </div>

                    <main className="max-w-7xl mx-auto p-6 no-print">
                        {activeTab === 'operacao' && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                    <div className="lg:col-span-2 bg-white p-6 rounded-xl shadow">
                                        <div className="flex justify-between mb-4">
                                            <h2 className="text-lg font-bold">Nova Entrada</h2>
                                            <div className="flex bg-gray-100 p-1 rounded">
                                                <button onClick={()=>setModoEntrada('scanner')} className={`px-3 py-1 text-xs rounded ${modoEntrada==='scanner'?'bg-white shadow':'text-gray-500'}`}>Scanner</button>
                                                <button onClick={()=>setModoEntrada('massa')} className={`px-3 py-1 text-xs rounded ${modoEntrada==='massa'?'bg-white shadow':'text-gray-500'}`}>Massa</button>
                                            </div>
                                        </div>
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-2 gap-4">
                                                <input list="bases-list" value={novaBase} onChange={e=>setNovaBase(e.target.value)} className="border p-2 rounded font-bold uppercase" placeholder="BASE/SEGMENTO" />
                                                <datalist id="bases-list">{listaBases.map((b,i)=><option key={i} value={b}/>)}</datalist>
                                                <select value={novoPeriodo} onChange={e=>setNovoPeriodo(e.target.value)} className="border p-2 rounded font-bold">
                                                    <option value="Manhã">Manhã</option>
                                                    <option value="Tarde">Tarde</option>
                                                </select>
                                            </div>
                                            {modoEntrada === 'scanner' ? (
                                                <form onSubmit={adicionarLote} className="flex gap-2">
                                                    <input ref={loteInputRef} value={novoLote} onChange={e=>setNovoLote(e.target.value)} className="flex-1 border p-2 rounded bg-yellow-50 font-mono" placeholder="BIPE O LOTE..." autoFocus />
                                                    <button className="bg-green-600 text-white px-6 rounded font-bold">Salvar</button>
                                                </form>
                                            ) : (
                                                <div className="space-y-2">
                                                    <textarea value={lotesMassa} onChange={e=>setLotesMassa(e.target.value)} className="w-full border p-2 rounded h-32 font-mono text-xs" placeholder="Cole os códigos..."></textarea>
                                                    <button onClick={adicionarLotesMassa} className="w-full bg-indigo-600 text-white p-2 rounded font-bold">Importar Massa</button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <div className="bg-indigo-50 p-6 rounded-xl border border-indigo-100">
                                        <h2 className="font-bold mb-4">Impressão do Dia</h2>
                                        <div className="space-y-3">
                                            <select value={baseParaImpressao} onChange={e=>setBaseParaImpressao(e.target.value)} className="w-full border p-2 rounded text-sm"><option value="">-- Selecione Base --</option>{listaBases.map((b,i)=><option key={i} value={b}>{b}</option>)}</select>
                                            <input type="date" value={dataImpressaoMassa} onChange={e=>setDataImpressaoMassa(e.target.value)} className="w-full border p-2 rounded text-sm" />
                                            <select value={periodoImpressao} onChange={e=>setPeriodoImpressao(e.target.value)} className="w-full border p-2 rounded text-sm">
                                                <option value="Todos">Todos Processados</option>
                                                <option value="Manhã">Manhã</option>
                                                <option value="Tarde">Tarde</option>
                                            </select>
                                            <button onClick={prepararImpressaoDoDia} className="w-full bg-indigo-600 text-white p-2 rounded font-bold">Gerar Etiquetas</button>
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-6">
                                    <div className="bg-white rounded-xl shadow h-[600px] flex flex-col">
                                        <div className="p-4 bg-orange-50 border-b font-bold text-orange-800">Pendentes ({pendentes.length})</div>
                                        <div className="flex-1 overflow-auto p-4 space-y-4">
                                            {Object.entries(agrupados).map(([base, itens])=>(
                                                <div key={base} className="border rounded-lg overflow-hidden">
                                                    <div className="bg-gray-50 p-2 text-xs font-bold border-b">{base}</div>
                                                    <div className="divide-y">{itens.map(l=>(
                                                        <div key={l.id} className="p-2 flex justify-between items-center text-sm">
                                                            <div className="font-mono font-bold">{l.codigo}</div>
                                                            <button onClick={()=>mudarStatus(l.id,'impressao')} className="text-xs bg-white border px-2 py-1 rounded">Usar</button>
                                                        </div>
                                                    ))}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="bg-white rounded-xl shadow h-[600px] flex flex-col">
                                        <div className="p-4 bg-blue-50 border-b flex justify-between">
                                            <span className="font-bold text-blue-800">Processados</span>
                                            <input type="date" value={processadosDataFiltro} onChange={e=>setProcessadosDataFiltro(e.target.value)} className="text-xs border p-1 rounded" />
                                        </div>
                                        <div className="flex-1 overflow-auto p-4 space-y-2">
                                            {processados.map(l=>(
                                                <div key={l.id} className="border p-2 rounded flex justify-between items-center">
                                                    <div>
                                                        <div className="text-[10px] uppercase font-bold text-gray-400">{l.baseSegmento}</div>
                                                        <div className="font-mono font-bold">{l.codigo}</div>
                                                    </div>
                                                    <button onClick={()=>removerLote(l.id)} className="text-red-300 hover:text-red-500"><Icons.Trash2 className="w-4 h-4"/></button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'relatorio' && (
                            <div className="bg-white p-6 rounded-xl shadow space-y-4">
                                <div className="flex justify-between">
                                    <h2 className="font-bold">Relatório Geral</h2>
                                    <button onClick={()=>window.print()} className="bg-gray-800 text-white px-4 py-2 rounded">Imprimir</button>
                                </div>
                                <div className="grid grid-cols-3 gap-2">
                                    <input value={filtroTexto} onChange={e=>setFiltroTexto(e.target.value)} className="border p-2 rounded" placeholder="Lote..." />
                                    <select value={filtroBase} onChange={e=>setFiltroBase(e.target.value)} className="border p-2 rounded"><option value="">Bases</option>{listaBases.map((b,i)=><option key={i} value={b}>{b}</option>)}</select>
                                    <select value={filtroStatus} onChange={e=>setFiltroStatus(e.target.value)} className="border p-2 rounded"><option value="todos">Status</option><option value="pendente">Pendente</option><option value="impressao">Processado</option></select>
                                </div>
                                <table className="w-full text-left text-sm">
                                    <thead><tr className="bg-gray-100 border-b"><th className="p-2">Data</th><th className="p-2">Lote</th><th className="p-2">Base</th><th className="p-2">Status</th></tr></thead>
                                    <tbody className="divide-y">{lotesFiltradosRelatorio.map(l=>(<tr key={l.id}><td className="p-2">{l.dataCriacao}</td><td className="p-2 font-mono font-bold">{l.codigo}</td><td className="p-2">{l.baseSegmento}</td><td className="p-2">{l.status}</td></tr>))}</tbody>
                                </table>
                            </div>
                        )}

                        {activeTab === 'consulta' && (
                            <div className="max-w-xl mx-auto bg-white p-8 rounded-xl shadow text-center">
                                <h2 className="text-xl font-bold mb-4">Consultar Lote</h2>
                                <input value={consultaTermo} onChange={e=>setConsultaTermo(e.target.value)} className="w-full p-4 border-2 rounded-xl text-center font-mono text-2xl uppercase" placeholder="DIGITE O CÓDIGO" autoFocus />
                                <div className="mt-6 space-y-4">
                                    {lotes.filter(l=>l.codigo.includes(consultaTermo.toUpperCase()) && consultaTermo !== "").map(l=>(
                                        <div key={l.id} className="border p-4 rounded text-left">
                                            <div className="font-bold text-xl">{l.codigo}</div>
                                            <div className="text-sm text-gray-500">{l.baseSegmento} - {l.status.toUpperCase()}</div>
                                            <div className="mt-2 text-xs">{l.dataCriacao} às {l.horaCriacao}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* ÁREAS DE IMPRESSÃO */}
                    <div id="area-impressao-etiquetas" className="hidden">
                        {lotesParaImprimir.map(l=>{
                            const p=l.baseSegmento.split('—');
                            return (
                                <div key={l.id} className="label-card">
                                    <div className="label-header">
                                        <div><span className="header-title">SEGMENTO</span><div className="header-value">{p[0]||'783'}</div></div>
                                        <div><span className="header-title">BASE</span><div className="header-value">{p[1]||l.baseSegmento}</div></div>
                                    </div>
                                    <div className="label-content">
                                        <div style={{width:'80px',height:'80px'}}><QRCodeImage text={l.codigo} size={80}/></div>
                                        <div className="label-text">{l.codigo}</div>
                                    </div>
                                    <div className="label-footer">
                                        <div className="footer-title">EXPEDIÇÃO</div>
                                        <div className="check-item"><span className="check-box"></span> CONFERIDO</div>
                                        <div className="footer-inputs"><span>{l.dataCriacao}</span><span>{l.horaCriacao}</span></div>
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
