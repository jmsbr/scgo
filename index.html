<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Lotes - Impressão Geral</title>
    
    <!-- Bibliotecas de Estilo e React -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <!-- BIBLIOTECAS PARA EXPORTAÇÃO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- FIREBASE SETUP -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, query, orderBy, writeBatch 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAGOZjJ33KZIlBWmZ3v25EckcVCJU5PNxA",
            authDomain: "lotesc-3409d.firebaseapp.com",
            projectId: "lotesc-3409d",
            storageBucket: "lotesc-3409d.firebasestorage.app",
            messagingSenderId: "610707549267",
            appId: "1:610707549267:web:39dbe1e3c46089d40eaaa6",
            measurementId: "G-JCSGY55F5S"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.fb = { collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, query, orderBy, writeBatch };
        
        window.dbReady = true;
        window.dispatchEvent(new Event('db-ready'));
    </script>
    
    <style>
        @media print {
            /* Oculta tudo por padrão */
            body * {
                visibility: hidden;
            }
            
            /* Configuração da página e corpo para permitir fluxo total */
            @page { 
                size: A4 landscape; 
                margin: 5mm; 
            }
            body, html {
                height: auto !important;
                overflow: visible !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* Torna visível apenas a área de impressão e seus filhos */
            #area-impressao-etiquetas, #area-impressao-etiquetas * {
                visibility: visible;
            }

            /* Posicionamento absoluto para cobrir a tela, mas permitindo scroll/paginação */
            #area-impressao-etiquetas {
                position: absolute;
                top: 0;
                left: 0;
                width: 100% !important;
                display: grid !important;
                grid-template-columns: repeat(5, 1fr); /* 5 colunas fixas */
                gap: 2mm;
                padding: 0;
                margin: 0;
            }

            /* Garante que os cards não quebrem no meio */
            .label-card { 
                border: 1px solid #000; 
                height: 90mm; 
                display: flex; 
                flex-direction: column; 
                justify-content: space-between; 
                padding: 2px; 
                overflow: hidden; 
                box-sizing: border-box;
                break-inside: avoid;       /* Padrão moderno */
                page-break-inside: avoid;  /* Legado */
                background: white;
            }

            .label-header { border-bottom: 2px solid #000; display: flex; justify-content: space-around; padding-bottom: 2px; margin-bottom: 2px; }
            .header-title { font-size: 8px; font-weight: 700; color: #555; text-transform: uppercase; }
            .header-value { font-size: 14px; font-weight: 900; color: #000; line-height: 1; text-transform: uppercase; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
            .label-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
            .label-text { font-family: 'Courier New', monospace; font-weight: bold; font-size: 18px; margin-top: 5px; }
            .label-footer { border-top: 1px dashed #000; padding-top: 4px; font-size: 9px; }
            .footer-title { background: #eee; text-align: center; font-weight: bold; margin-bottom: 2px; font-size: 8px; }
            .check-item { display: flex; align-items: center; gap: 4px; justify-content: center; font-weight: bold; }
            .check-box { width: 10px; height: 10px; border: 1px solid #000; display: inline-block; }
            .footer-inputs { display: flex; justify-content: space-between; margin-top: 4px; font-size: 7px; font-weight: bold; border-top: 1px dotted #ccc; }
        }
        
        .invalid-base { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Plus: (props) => <Icon {...props} path={<React.Fragment><path d="M5 12h14"/><path d="M12 5v14"/></React.Fragment>} />,
            Printer: (props) => <Icon {...props} path={<React.Fragment><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></React.Fragment>} />,
            Package: (props) => <Icon {...props} path={<React.Fragment><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></React.Fragment>} />,
            ArrowRight: (props) => <Icon {...props} path={<React.Fragment><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></React.Fragment>} />,
            Trash2: (props) => <Icon {...props} path={<React.Fragment><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></React.Fragment>} />,
            Layers: (props) => <Icon {...props} path={<React.Fragment><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></React.Fragment>} />,
            FileText: (props) => <Icon {...props} path={<React.Fragment><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></React.Fragment>} />,
            Search: (props) => <Icon {...props} path={<React.Fragment><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></React.Fragment>} />,
            Clock: (props) => <Icon {...props} path={<React.Fragment><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></React.Fragment>} />,
            CheckSquare: (props) => <Icon {...props} path={<React.Fragment><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></React.Fragment>} />,
            Activity: (props) => <Icon {...props} path={<React.Fragment><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></React.Fragment>} />,
            Download: (props) => <Icon {...props} path={<React.Fragment><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></React.Fragment>} />,
            Code: (props) => <Icon {...props} path={<React.Fragment><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></React.Fragment>} />,
            X: (props) => <Icon {...props} path={<React.Fragment><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></React.Fragment>} />,
            Calendar: (props) => <Icon {...props} path={<React.Fragment><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></React.Fragment>} />,
            List: (props) => <Icon {...props} path={<React.Fragment><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></React.Fragment>} />
        };

        const LISTA_PADRAO = [
          "751-02 — SMB - GO", "751-05 — F RVD - GO", "751-06 — IPR - GO", "751-07 — F TRD - GO",
          "751-08 — F GYN - GO", "751-10 — F ANP - GO", "751-14 — F APG - GO",
          "751-18 — F CTL - GO", "751-24 — F GYN 02 - GO", "751-25 — F SEN - GO",
          "751-26 — GYN 05 - GO", "760-00 — F GYN 04 - GO",
          "752-00 — F PDR - GO", "759-00 — F PON - GO", "762-00 — F GYN 03 - GO",
          "783-00 — F QUI-GO",
          "782-00 — F CRX - GO", "758-00 — F JRG - GO"
        ];

        const playErrorSound = () => {
            try {
                const context = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = context.createOscillator();
                const gain = context.createGain();
                oscillator.connect(gain);
                gain.connect(context.destination);
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(150, context.currentTime);
                gain.gain.setValueAtTime(0.1, context.currentTime);
                oscillator.start();
                oscillator.stop(context.currentTime + 0.3);
            } catch (e) { console.warn("Erro de som:", e); }
        };

        const formatDateToPTBR = (isoDate) => {
            if (!isoDate) return '';
            const [y, m, d] = isoDate.split('-');
            return `${d}/${m}/${y}`;
        };

        const getTodayISO = () => {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };

        const QRCodeImage = ({ text, size = 100 }) => {
            const canvasRef = useRef(null);
            useEffect(() => {
                if (window.QRious && canvasRef.current) {
                    new window.QRious({ element: canvasRef.current, value: text, size: size, level: 'M' });
                }
            }, [text, size]);
            return <canvas ref={canvasRef} width={size} height={size} style={{ width: '100%', height: 'auto' }} />;
        };

        function App() {
            const [activeTab, setActiveTab] = useState('operacao');
            const [listaBases, setListaBases] = useState(LISTA_PADRAO);
            const [lotes, setLotes] = useState([]);
            const [dbConnected, setDbConnected] = useState(false);

            const [modoEntrada, setModoEntrada] = useState('scanner');
            const [novoLote, setNovoLote] = useState('');
            const [lotesMassa, setLotesMassa] = useState('');
            const [novaBase, setNovaBase] = useState('');
            const [novoPeriodo, setNovoPeriodo] = useState('Manhã'); 
            const loteInputRef = useRef(null);

            // ESTADO DE SELEÇÃO MULTIPLA PARA IMPRESSÃO
            const [basesSelecionadas, setBasesSelecionadas] = useState(new Set()); 
            const [periodoImpressao, setPeriodoImpressao] = useState('Todos'); 
            const [lotesParaImprimir, setLotesParaImprimir] = useState([]);
            const [selectedIds, setSelectedIds] = useState(new Set()); 
            const [dataImpressaoMassa, setDataImpressaoMassa] = useState(getTodayISO());

            const [filtroTexto, setFiltroTexto] = useState('');
            const [filtroBase, setFiltroBase] = useState('');
            const [filtroStatus, setFiltroStatus] = useState('todos');
            const [dataInicio, setDataInicio] = useState('');
            const [dataFim, setDataFim] = useState('');

            const [pendenteBuscaLote, setPendenteBuscaLote] = useState('');
            const [pendenteBuscaBase, setPendenteBuscaBase] = useState('');
            
            const [processadosDataFiltro, setProcessadosDataFiltro] = useState(getTodayISO());
            const [processadoBusca, setProcessadoBusca] = useState('');
            const [processadoBaseFiltro, setProcessadoBaseFiltro] = useState(''); 
            const [dataParaMover, setDataParaMover] = useState('');
            const [baseParaAlterar, setBaseParaAlterar] = useState('');

            // MONITORAMENTO NOVO
            const [dataMonitoramento, setDataMonitoramento] = useState(getTodayISO());

            const [consultaTermo, setConsultaTermo] = useState('');
            const [now, setNow] = useState(Date.now());

            const SENHA_MESTRA = "JT@2026";
            const isBaseValida = (base) => listaBases.includes(base);

            // Controle para evitar beeps infinitos ao digitar
            const lastBaseStatusRef = useRef(true);

            useEffect(() => {
                const isValid = isBaseValida(novaBase);
                if (novaBase && !isValid && lastBaseStatusRef.current === true) {
                    playErrorSound();
                }
                lastBaseStatusRef.current = !novaBase || isValid;
            }, [novaBase]);

            // --- FUNÇÕES DE LOGICA ---

            const toggleBaseImpressao = (base) => {
                const newSet = new Set(basesSelecionadas);
                if (newSet.has(base)) newSet.delete(base);
                else newSet.add(base);
                setBasesSelecionadas(newSet);
            };

            const toggleTodasBasesImpressao = () => {
                if (basesSelecionadas.size === listaBases.length) {
                    setBasesSelecionadas(new Set());
                } else {
                    setBasesSelecionadas(new Set(listaBases));
                }
            };

            const verificarAlerta10Horas = (timestamp) => {
                if (!timestamp) return false;
                return (now - timestamp) / 3600000 >= 10;
            };

            const imprimirSelecionados = () => {
                if (selectedIds.size === 0) return alert("Selecione pelo menos um lote.");
                const selecionados = lotes.filter(l => selectedIds.has(l.id));
                setLotesParaImprimir(selecionados);
                setTimeout(() => window.print(), 500);
            };

            const mudarStatusEmMassa = async (itens, novoStatus) => {
                if (!dbConnected) return;
                if (!confirm(`Confirma mover TODOS os ${itens.length} itens deste segmento para Processados?`)) return;

                const batch = window.fb.writeBatch(window.db);
                const dataHora = new Date().toLocaleString('pt-BR');

                itens.forEach(item => {
                    const docRef = window.fb.doc(window.db, "lotes", item.id);
                    const novoHistorico = [
                        ...(item.historico || []),
                        { status: novoStatus.toUpperCase(), data: dataHora, detalhe: 'Ação em massa por segmento' }
                    ];
                    batch.update(docRef, { status: novoStatus, historico: novoHistorico });
                });

                try {
                    await batch.commit();
                } catch (error) {
                    console.error("Erro em massa:", error);
                    alert("Erro ao atualizar em massa.");
                }
            };

            const lotesFiltradosRelatorio = useMemo(() => {
                return lotes.filter(lote => {
                    const matchTexto = lote.codigo.includes(filtroTexto.toUpperCase());
                    const matchBase = filtroBase === "" || lote.baseSegmento === filtroBase;
                    const matchStatus = filtroStatus !== 'todos' ? lote.status === filtroStatus : true;
                    let matchData = true;
                    if (dataInicio || dataFim) {
                        let loteISO = "";
                        if (lote.timestampCriacao) {
                            const d = new Date(lote.timestampCriacao);
                            loteISO = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
                        } else if (lote.dataCriacao) {
                            const parts = lote.dataCriacao.split('/');
                            if (parts.length === 3) loteISO = `${parts[2]}-${parts[1]}-${parts[0]}`;
                        }
                        if (loteISO) {
                            if (dataInicio && loteISO < dataInicio) matchData = false;
                            if (dataFim && loteISO > dataFim) matchData = false;
                        } else {
                            matchData = false;
                        }
                    }
                    return matchTexto && matchBase && matchStatus && matchData;
                });
            }, [lotes, filtroTexto, filtroBase, filtroStatus, dataInicio, dataFim]);

            // --- LOGICA MONITORAMENTO POR BASE ---
            const statsPorBase = useMemo(() => {
                const dataBR = formatDateToPTBR(dataMonitoramento);
                
                // Filtra lotes do dia selecionado
                const lotesDoDia = lotes.filter(l => l.dataCriacao === dataBR);
                
                // Agrupa por base
                const agrupamento = {};
                listaBases.forEach(b => agrupamento[b] = 0); // Inicializa com 0
                
                lotesDoDia.forEach(l => {
                    if (agrupamento[l.baseSegmento] !== undefined) {
                        agrupamento[l.baseSegmento]++;
                    } else {
                        // Caso existam bases antigas que não estão mais na lista padrão, opcionalmente adicionamos
                        agrupamento[l.baseSegmento] = (agrupamento[l.baseSegmento] || 0) + 1;
                    }
                });

                // Converte para array e ordena por maior quantidade
                return Object.entries(agrupamento)
                    .map(([base, count]) => ({ base, count }))
                    .sort((a, b) => b.count - a.count); // Ordena decrescente
            }, [lotes, dataMonitoramento, listaBases]);

            // --- FUNÇÕES DE EXPORTAÇÃO (NOVO) ---

            const exportarCSV = () => {
                if (lotesFiltradosRelatorio.length === 0) return alert("Nada para exportar");
                
                const cabecalho = "Data;Lote;Base;Status;Periodo;Hora";
                const linhas = lotesFiltradosRelatorio.map(l => 
                    `${l.dataCriacao};${l.codigo};${l.baseSegmento};${l.status};${l.periodo};${l.horaCriacao}`
                );
                
                const csvContent = "data:text/csv;charset=utf-8," + [cabecalho, ...linhas].join("\n");
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `relatorio_lotes_${getTodayISO()}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const exportarExcel = () => {
                if (lotesFiltradosRelatorio.length === 0) return alert("Nada para exportar");
                
                // Prepara dados para SheetJS
                const dadosFormatados = lotesFiltradosRelatorio.map(l => ({
                    "Data Criação": l.dataCriacao,
                    "Hora": l.horaCriacao,
                    "Código Lote": l.codigo,
                    "Base/Segmento": l.baseSegmento,
                    "Status": l.status,
                    "Período": l.periodo
                }));

                const worksheet = XLSX.utils.json_to_sheet(dadosFormatados);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Relatório Lotes");
                
                // Ajusta largura das colunas
                const wscols = [
                    {wch:12}, {wch:10}, {wch:25}, {wch:30}, {wch:15}, {wch:10}
                ];
                worksheet['!cols'] = wscols;

                XLSX.writeFile(workbook, `relatorio_lotes_${getTodayISO()}.xlsx`);
            };

            const exportarPDF = () => {
                if (lotesFiltradosRelatorio.length === 0) return alert("Nada para exportar");
                if (!window.jspdf) return alert("Biblioteca PDF não carregou.");

                const doc = new window.jspdf.jsPDF();
                
                doc.setFontSize(16);
                doc.text("Relatório de Sistema de Lotes", 14, 20);
                doc.setFontSize(10);
                doc.text(`Gerado em: ${new Date().toLocaleString()}`, 14, 26);
                doc.text(`Total de registros: ${lotesFiltradosRelatorio.length}`, 14, 32);

                const tableColumn = ["Data", "Hora", "Lote", "Base", "Status", "Período"];
                const tableRows = lotesFiltradosRelatorio.map(l => [
                    l.dataCriacao,
                    l.horaCriacao,
                    l.codigo,
                    l.baseSegmento,
                    l.status,
                    l.periodo
                ]);

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 36,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [63, 81, 181] } // Indigo
                });

                doc.save(`relatorio_lotes_${getTodayISO()}.pdf`);
            };

            // --- CONEXÃO FIREBASE ---

            useEffect(() => {
                const iniciarConexao = () => {
                    if (window.db && window.fb) {
                        setDbConnected(true);
                        const q = window.fb.query(window.fb.collection(window.db, "lotes"), window.fb.orderBy("timestampCriacao", "desc"));
                        const unsubscribe = window.fb.onSnapshot(q, (snapshot) => {
                            const list = [];
                            snapshot.forEach(doc => list.push({ ...doc.data(), id: doc.id }));
                            setLotes(list);
                        }, (err) => console.error(err));
                        return unsubscribe;
                    }
                };
                if (window.dbReady) {
                    const unsub = iniciarConexao();
                    return () => unsub && unsub();
                } else {
                    window.addEventListener('db-ready', iniciarConexao);
                    return () => window.removeEventListener('db-ready', iniciarConexao);
                }
            }, []);

            useEffect(() => {
                const interval = setInterval(() => setNow(Date.now()), 60000);
                return () => clearInterval(interval);
            }, []);

            // --- AÇÕES DO USUÁRIO ---

            const adicionarLote = (e) => {
                e.preventDefault();
                const codigo = novoLote.trim().toUpperCase();
                const base = novaBase;
                
                setNovoLote('');
                if (loteInputRef.current) loteInputRef.current.focus();

                if (!codigo) return;

                if (!base || !isBaseValida(base)) {
                    playErrorSound();
                    return;
                }

                if ((codigo.match(/BR/g) || []).length > 1) {
                    playErrorSound();
                    alert(`⚠️ ERRO: Leitura duplicada detectada.`);
                    return;
                }

                const dataAtual = new Date();
                window.fb.addDoc(window.fb.collection(window.db, "lotes"), {
                    codigo, status: 'pendente', baseSegmento: base, periodo: novoPeriodo,
                    timestampCriacao: dataAtual.getTime(), dataCriacao: dataAtual.toLocaleDateString('pt-BR'),
                    horaCriacao: dataAtual.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                    historico: [{ status: 'CRIADO', data: dataAtual.toLocaleString('pt-BR'), detalhe: 'Entrada rápida (Scanner)' }]
                });
            };

            const adicionarLotesMassa = async () => {
                if (!lotesMassa.trim() || !novaBase || !isBaseValida(novaBase)) {
                    playErrorSound();
                    return alert("Verifique a lista e a base.");
                }
                const codigos = lotesMassa.split(/\r?\n/).map(c => c.trim().toUpperCase()).filter(c => c !== '');
                const batch = window.fb.writeBatch(window.db);
                const dataAtual = new Date();
                codigos.forEach(cod => {
                    const ref = window.fb.doc(window.fb.collection(window.db, "lotes"));
                    batch.set(ref, {
                        codigo: cod, status: 'pendente', baseSegmento: novaBase, periodo: novoPeriodo,
                        timestampCriacao: dataAtual.getTime(), dataCriacao: dataAtual.toLocaleDateString('pt-BR'),
                        horaCriacao: dataAtual.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                        historico: [{ status: 'CRIADO', data: dataAtual.toLocaleString('pt-BR'), detalhe: 'Importação em massa' }]
                    });
                });
                await batch.commit();
                setLotesMassa('');
                setModoEntrada('scanner');
                alert("Importados.");
            };

            const mudarStatus = async (id, status) => {
                const lote = lotes.find(l => l.id === id);
                if (!lote) return;
                const hist = [...(lote.historico || []), { status: status.toUpperCase(), data: new Date().toLocaleString('pt-BR'), detalhe: 'Alteração de status' }];
                await window.fb.updateDoc(window.fb.doc(window.db, "lotes", id), { status, historico: hist });
            };

            const removerLote = async (id) => {
                const lote = lotes.find(l => l.id === id);
                if (!lote) return;
                if (lote.status === 'impressao') {
                    if (prompt("Item Processado! Senha para excluir:") !== SENHA_MESTRA) return alert("Senha incorreta.");
                } else if (!confirm("Excluir este lote?")) return;
                await window.fb.deleteDoc(window.fb.doc(window.db, "lotes", id));
            };

            const toggleSelection = (id) => {
                const next = new Set(selectedIds);
                if (next.has(id)) next.delete(id); else next.add(id);
                setSelectedIds(next);
            };

            const moverLotesSelecionados = async () => {
                if (selectedIds.size === 0 || !dataParaMover) return alert("Selecione os lotes e a data.");
                if (prompt("Digite a senha para MOVER:") !== SENHA_MESTRA) return alert("Senha incorreta.");
                const novaDataBR = formatDateToPTBR(dataParaMover);
                for (let id of selectedIds) {
                    const lote = lotes.find(l => l.id === id);
                    if (lote) {
                        const hist = [...(lote.historico || []), { status: 'MOVIDO', data: new Date().toLocaleString('pt-BR'), detalhe: `Data para ${novaDataBR}` }];
                        await window.fb.updateDoc(window.fb.doc(window.db, "lotes", id), { dataCriacao: novaDataBR, historico: hist });
                    }
                }
                setSelectedIds(new Set());
                alert("Lotes movidos com sucesso!");
            };

            const alterarBaseSelecionados = async () => {
                if (selectedIds.size === 0 || !baseParaAlterar) return alert("Selecione os lotes e a nova base.");
                if (prompt("Digite a senha para ALTERAR BASE:") !== SENHA_MESTRA) return alert("Senha incorreta.");
                for (let id of selectedIds) {
                    const lote = lotes.find(l => l.id === id);
                    if (lote) {
                        const hist = [...(lote.historico || []), { status: 'BASE_ALT', data: new Date().toLocaleString('pt-BR'), detalhe: `Base para ${baseParaAlterar}` }];
                        await window.fb.updateDoc(window.fb.doc(window.db, "lotes", id), { baseSegmento: baseParaAlterar, historico: hist });
                    }
                }
                setSelectedIds(new Set());
                setBaseParaAlterar('');
                alert("Base alterada com sucesso!");
            };

            const prepararImpressaoDoDia = async () => {
                if (basesSelecionadas.size === 0) return alert("Selecione ao menos uma base para imprimir.");
                
                const dataBR = formatDateToPTBR(dataImpressaoMassa);
                
                let filtrados = lotes.filter(l => 
                    basesSelecionadas.has(l.baseSegmento) && // Filtra apenas bases selecionadas
                    l.dataCriacao === dataBR && 
                    (periodoImpressao === 'Todos' ? true : l.periodo === periodoImpressao)
                );
                
                if (filtrados.length === 0) return alert("Nada encontrado para os filtros selecionados.");
                
                // ORDENAÇÃO POR BASE
                filtrados.sort((a, b) => {
                    const baseA = a.baseSegmento || '';
                    const baseB = b.baseSegmento || '';
                    return baseA.localeCompare(baseB) || a.codigo.localeCompare(b.codigo);
                });

                const pendentes = filtrados.filter(l => l.status === 'pendente');
                if (pendentes.length > 0) {
                    if(!confirm(`Serão processados ${pendentes.length} itens de ${basesSelecionadas.size} bases. Confirma?`)) return;

                    const batch = window.fb.writeBatch(window.db);
                    pendentes.forEach(p => {
                        const h = [...(p.historico || []), { status: 'IMPRESSAO', data: new Date().toLocaleString('pt-BR'), detalhe: `Fechamento ${periodoImpressao} (Em Massa)` }];
                        batch.update(window.fb.doc(window.db, "lotes", p.id), { status: 'impressao', historico: h });
                    });
                    await batch.commit();
                }
                setLotesParaImprimir(filtrados);
                setTimeout(() => window.print(), 500);
            };

            // --- FILTROS DE INTERFACE ---

            const pendentes = lotes.filter(l => l.status === 'pendente');
            const agrupadosPendentes = pendentes.filter(l => l.codigo.includes(pendenteBuscaLote.toUpperCase()) && l.baseSegmento.includes(pendenteBuscaBase.toUpperCase())).reduce((acc, l) => {
                acc[l.baseSegmento] = acc[l.baseSegmento] || [];
                acc[l.baseSegmento].push(l);
                return acc;
            }, {});

            const processados = lotes.filter(l => l.status === 'impressao' && l.dataCriacao === formatDateToPTBR(processadosDataFiltro) && (processadoBaseFiltro ? l.baseSegmento === processadoBaseFiltro : true) && (processadoBusca ? l.codigo.includes(processadoBusca.toUpperCase()) : true));
            const alertas = pendentes.filter(l => verificarAlerta10Horas(l.timestampCriacao));

            const tabConfig = {
                operacao: { label: 'Operação', icon: <Icons.Layers className="w-4 h-4"/> },
                monitoramento: { label: 'Monitor', icon: <Icons.Activity className="w-4 h-4"/> },
                relatorio: { label: 'Relatórios', icon: <Icons.FileText className="w-4 h-4"/> },
                consulta: { label: 'Consulta', icon: <Icons.Search className="w-4 h-4"/> },
            };

            return (
                <div className="min-h-screen bg-gray-100 font-sans text-gray-800">
                    <div className="bg-slate-900 text-white shadow-lg no-print">
                        <div className="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-3">
                                <Icons.Package className="w-8 h-8 text-indigo-400" />
                                <div>
                                    <h1 className="text-2xl font-bold uppercase tracking-tight">Sistema de Lotes</h1>
                                    <p className="text-slate-400 text-[10px] flex items-center gap-1 uppercase">
                                        <span className={`w-2 h-2 rounded-full ${dbConnected ? 'bg-green-500' : 'bg-red-500'}`}></span>
                                        {dbConnected ? 'CONECTADO AO BANCO' : 'OFFLINE'}
                                    </p>
                                </div>
                            </div>
                            
                            <div className="flex bg-slate-800 p-1 rounded-lg overflow-x-auto">
                                {Object.entries(tabConfig).map(([key, config]) => (
                                    <button 
                                        key={key} 
                                        onClick={()=>setActiveTab(key)} 
                                        className={`px-4 py-2 rounded-md text-sm font-bold flex items-center gap-2 transition ${activeTab===key?'bg-indigo-600 shadow text-white':'text-slate-300 hover:bg-slate-700 hover:text-white'}`}
                                    >
                                        {config.icon}
                                        {config.label}
                                        {key === 'monitoramento' && alertas.length > 0 && (
                                            <span className="bg-red-500 text-white px-1.5 rounded-full text-[10px] animate-pulse">
                                                {alertas.length}
                                            </span>
                                        )}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    <main className="max-w-7xl mx-auto p-4 md:p-6 no-print">
                        {activeTab === 'operacao' && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                    <div className="lg:col-span-2 bg-white p-6 rounded-xl shadow border border-gray-200">
                                        <div className="flex justify-between items-center mb-4">
                                            <h2 className="text-lg font-bold text-gray-700 flex gap-2"><Icons.Plus className="text-green-600"/> Registrar Entrada</h2>
                                            <div className="flex bg-gray-100 rounded-lg p-1 text-[10px] font-bold">
                                                <button onClick={()=>setModoEntrada('scanner')} className={`px-3 py-1 rounded transition ${modoEntrada==='scanner'?'bg-white shadow text-indigo-600':'text-gray-500'}`}>SCANNER</button>
                                                <button onClick={()=>setModoEntrada('massa')} className={`px-3 py-1 rounded transition ${modoEntrada==='massa'?'bg-white shadow text-indigo-600':'text-gray-500'}`}>EM MASSA</button>
                                            </div>
                                        </div>
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div className="relative">
                                                    <label className="text-[10px] font-bold text-gray-500 uppercase">Base / Segmento (Obrigatório)</label>
                                                    <input 
                                                        list="bases-op" 
                                                        value={novaBase} 
                                                        onChange={e=>setNovaBase(e.target.value)} 
                                                        className={`w-full border rounded-lg px-4 py-2 uppercase font-bold text-sm ${novaBase && !isBaseValida(novaBase) ? 'invalid-base shake' : ''}`} 
                                                        placeholder="Escolha a base..." 
                                                    />
                                                    <datalist id="bases-op">{listaBases.map(b=><option key={b} value={b}/>)}</datalist>
                                                    {novaBase && !isBaseValida(novaBase) && (
                                                        <div className="absolute left-0 mt-1 w-full bg-red-100 text-red-700 p-2 rounded border border-red-200 text-[10px] font-bold z-10 shadow-sm">
                                                            ⚠️ BASE INEXISTENTE! <br/>
                                                            Selecione uma base disponível no cadastro para continuar.
                                                        </div>
                                                    )}
                                                </div>
                                                <div>
                                                    <label className="text-[10px] font-bold text-gray-500 uppercase">Período</label>
                                                    <select value={novoPeriodo} onChange={e=>setNovoPeriodo(e.target.value)} className="w-full border rounded-lg px-4 py-2 text-sm font-bold bg-white focus:outline-none">
                                                        <option value="Manhã">Manhã</option><option value="Tarde">Tarde</option>
                                                    </select>
                                                </div>
                                            </div>
                                            {modoEntrada === 'scanner' ? (
                                                <form onSubmit={adicionarLote} className="flex gap-2">
                                                    <input ref={loteInputRef} value={novoLote} onChange={e=>setNovoLote(e.target.value)} className="flex-1 border rounded-lg px-4 py-3 font-mono font-bold bg-yellow-50 text-xl focus:ring-4 focus:ring-yellow-100" placeholder="BIPAR LOTE..." autoFocus />
                                                    <button type="submit" disabled={novaBase && !isBaseValida(novaBase)} className={`font-bold px-6 rounded-lg transition ${novaBase && !isBaseValida(novaBase) ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-green-600 text-white hover:bg-green-700'}`}>SALVAR</button>
                                                </form>
                                            ) : (
                                                <div className="space-y-2">
                                                    <textarea value={lotesMassa} onChange={e=>setLotesMassa(e.target.value)} className="w-full border rounded-lg p-3 font-mono text-xs h-32 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Cole os códigos (1 por linha)..."></textarea>
                                                    <button onClick={adicionarLotesMassa} disabled={novaBase && !isBaseValida(novaBase)} className="w-full bg-indigo-600 text-white font-bold py-2 rounded-lg disabled:bg-gray-400">PROCESSAR TUDO</button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <div className="bg-indigo-50 p-6 rounded-xl border border-indigo-100 shadow-sm flex flex-col">
                                        <h2 className="font-bold text-indigo-900 mb-4 uppercase text-[10px] flex gap-2"><Icons.Printer className="w-4 h-4"/> Impressão Diária</h2>
                                        
                                        <div className="space-y-3 flex-1 flex flex-col">
                                            <input type="date" value={dataImpressaoMassa} onChange={e=>setDataImpressaoMassa(e.target.value)} className="w-full border rounded-lg px-3 py-2 text-xs focus:outline-none" />
                                            <select value={periodoImpressao} onChange={e=>setPeriodoImpressao(e.target.value)} className="w-full border rounded-lg px-3 py-2 text-xs focus:outline-none"><option value="Todos">TODOS PERIODOS</option><option value="Manhã">MANHÃ</option><option value="Tarde">TARDE</option></select>
                                            
                                            <div className="flex-1 bg-white border rounded-lg p-2 overflow-y-auto max-h-40 space-y-1">
                                                <div className="flex items-center gap-2 border-b pb-1 mb-1 sticky top-0 bg-white z-10">
                                                    <input type="checkbox" checked={basesSelecionadas.size === listaBases.length && listaBases.length > 0} onChange={toggleTodasBasesImpressao} className="cursor-pointer"/>
                                                    <span className="text-[10px] font-bold uppercase text-gray-700">Selecionar Todas</span>
                                                </div>
                                                {listaBases.map(b => (
                                                    <div key={b} className="flex items-center gap-2 hover:bg-gray-50 p-1 rounded">
                                                        <input type="checkbox" checked={basesSelecionadas.has(b)} onChange={()=>toggleBaseImpressao(b)} className="cursor-pointer"/>
                                                        <span className="text-[9px] uppercase truncate text-gray-600 font-medium cursor-pointer" onClick={()=>toggleBaseImpressao(b)}>{b}</span>
                                                    </div>
                                                ))}
                                            </div>

                                            <button onClick={prepararImpressaoDoDia} className="w-full bg-slate-800 text-white font-bold py-3 rounded-lg text-[10px] hover:bg-slate-900 uppercase shadow-sm border border-slate-600 flex items-center justify-center gap-2">
                                                <Icons.Printer className="w-3 h-3"/> Gerar Etiquetas ({basesSelecionadas.size})
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="bg-white rounded-xl shadow border h-[550px] flex flex-col overflow-hidden">
                                        <div className="p-4 bg-orange-50 border-b flex justify-between items-center">
                                            <h3 className="font-bold text-orange-800 uppercase text-xs flex gap-2 items-center"><Icons.Clock className="w-4 h-4"/> Pendentes</h3>
                                            <span className="bg-orange-200 text-orange-900 px-2 rounded-full font-bold text-[10px]">{pendentes.length}</span>
                                        </div>
                                        <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                            {Object.entries(agrupadosPendentes).map(([base, list]) => (
                                                <div key={base} className="border rounded-lg overflow-hidden shadow-sm">
                                                    <div className="bg-gray-100 p-2 text-[10px] font-bold flex justify-between uppercase">{base} <button onClick={()=>mudarStatusEmMassa(list,'impressao')} className="text-green-700 hover:underline">USAR GRUPO</button></div>
                                                    <div className="divide-y">{list.map(l=>(
                                                        <div key={l.id} className={`p-3 flex justify-between items-center ${verificarAlerta10Horas(l.timestampCriacao)?'bg-red-50':''}`}>
                                                            <div className="font-mono font-bold uppercase">{l.codigo}</div>
                                                            <div className="flex gap-2">
                                                                <button onClick={()=>removerLote(l.id)} className="text-red-300 hover:text-red-600"><Icons.Trash2 className="w-4 h-4"/></button>
                                                                <button onClick={()=>mudarStatus(l.id,'impressao')} className="text-[10px] border px-2 py-1 rounded font-bold bg-white hover:bg-green-50 shadow-sm uppercase">Usar</button>
                                                            </div>
                                                        </div>
                                                    ))}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="bg-white rounded-xl shadow border h-[550px] flex flex-col overflow-hidden">
                                        <div className="p-4 bg-blue-50 border-b">
                                            <div className="flex justify-between items-center mb-2">
                                                <h3 className="font-bold text-blue-800 uppercase text-xs flex gap-2 items-center"><Icons.CheckSquare className="w-4 h-4"/> Processados</h3>
                                                <div className="flex items-center gap-2">
                                                    <Icons.Calendar className="w-3 h-3 text-blue-500" />
                                                    <input type="date" value={processadosDataFiltro} onChange={e=>setProcessadosDataFiltro(e.target.value)} className="text-[10px] border rounded p-1 focus:outline-none"/>
                                                    <span className="bg-blue-200 text-blue-900 px-2 rounded-full font-bold text-[10px]">{processados.length}</span>
                                                </div>
                                            </div>
                                            <div className="flex gap-2">
                                                <input value={processadoBusca} onChange={e=>setProcessadoBusca(e.target.value)} className="flex-1 text-[10px] border rounded p-1 focus:outline-none" placeholder="Lote..."/>
                                                <select value={processadoBaseFiltro} onChange={e=>setProcessadoBaseFiltro(e.target.value)} className="text-[10px] border rounded p-1 focus:outline-none"><option value="">Todas Bases</option>{listaBases.map(b=><option key={b} value={b}>{b}</option>)}</select>
                                            </div>
                                        </div>
                                        <div className="flex-1 overflow-y-auto p-4 space-y-2">
                                            {processados.map(l=>(
                                                <div key={l.id} className={`border p-3 rounded-lg flex justify-between items-center transition ${selectedIds.has(l.id)?'bg-blue-100 border-blue-400':'bg-white'}`}>
                                                    <div className="flex gap-3 items-center">
                                                        <input type="checkbox" checked={selectedIds.has(l.id)} onChange={()=>toggleSelection(l.id)} className="w-5 h-5 cursor-pointer"/>
                                                        <div>
                                                            <div className="font-mono font-bold text-lg uppercase">{l.codigo}</div>
                                                            <div className="text-[9px] text-blue-600 font-bold uppercase">{l.baseSegmento}</div>
                                                        </div>
                                                    </div>
                                                    <button onClick={()=>removerLote(l.id)} className="text-red-300 hover:text-red-600"><Icons.Trash2 className="w-4 h-4"/></button>
                                                </div>
                                            ))}
                                            {selectedIds.size > 0 && (
                                                <div className="sticky bottom-0 bg-white p-3 border-t shadow-2xl space-y-3">
                                                    <div className="flex gap-2">
                                                        <input type="date" value={dataParaMover} onChange={e=>setDataParaMover(e.target.value)} className="flex-1 text-[10px] border rounded p-1 focus:outline-none" />
                                                        <button onClick={moverLotesSelecionados} className="bg-orange-600 text-white font-bold px-3 py-1 rounded text-[10px] uppercase shadow-sm">Mover Data</button>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <select value={baseParaAlterar} onChange={e=>setBaseParaAlterar(e.target.value)} className="flex-1 text-[10px] border rounded p-1 focus:outline-none">
                                                            <option value="">Nova Base...</option>
                                                            {listaBases.map(b=><option key={b} value={b}>{b}</option>)}
                                                        </select>
                                                        <button onClick={alterarBaseSelecionados} className="bg-blue-600 text-white font-bold px-3 py-1 rounded text-[10px] uppercase shadow-sm">Mudar Base</button>
                                                    </div>
                                                    <button onClick={imprimirSelecionados} className="w-full bg-slate-800 text-white font-bold py-2 rounded text-[10px] uppercase shadow-sm flex items-center justify-center gap-2">
                                                        <Icons.Printer className="w-3 h-3"/> Imprimir ({selectedIds.size})
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'monitoramento' && (
                            <div className="space-y-6">
                                {/* PAINEL DE CONTAGEM DIÁRIA */}
                                <div className="bg-white p-6 rounded-xl shadow border border-gray-200">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-xl font-bold flex gap-2 items-center tracking-tight text-gray-700">
                                            <Icons.Layers className="text-indigo-600"/> Produção Diária por Base
                                        </h2>
                                        <div className="flex items-center gap-2 bg-gray-100 p-2 rounded-lg">
                                            <span className="text-[10px] font-bold text-gray-500 uppercase">Data Ref:</span>
                                            <input 
                                                type="date" 
                                                value={dataMonitoramento} 
                                                onChange={e => setDataMonitoramento(e.target.value)} 
                                                className="text-xs font-bold bg-white border rounded px-2 py-1 focus:outline-none"
                                            />
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                        {statsPorBase.map((stat, idx) => (
                                            <div key={idx} className="bg-gradient-to-br from-white to-gray-50 border p-4 rounded-xl shadow-sm flex flex-col items-center justify-center text-center hover:shadow-md transition">
                                                <div className="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-1">
                                                    {stat.base.split('—')[0] || 'BASE'}
                                                </div>
                                                <div className="text-[10px] font-black text-indigo-900 uppercase leading-tight h-8 flex items-center justify-center">
                                                    {stat.base.split('—')[1] || stat.base}
                                                </div>
                                                <div className="text-3xl font-black text-indigo-600 mt-2">
                                                    {stat.count}
                                                </div>
                                                <div className="text-[8px] text-gray-400 mt-1 uppercase">Lotes Gerados</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* LISTA DE ATRASOS CRÍTICOS */}
                                <div className="bg-white p-6 rounded-xl shadow border border-gray-200">
                                    <h2 className="text-xl font-bold mb-6 flex gap-2 items-center tracking-tight text-gray-700">
                                        <Icons.Activity className="text-red-600"/> Monitor de Atrasos (+10H)
                                    </h2>
                                    {alertas.length > 0 ? (
                                        <div className="space-y-4">{alertas.map(l=>(
                                            <div key={l.id} className="p-4 border-l-4 border-red-500 bg-red-50 flex justify-between items-center rounded-r-lg shadow-sm">
                                                <div>
                                                    <div className="font-bold text-red-800 text-lg uppercase font-mono">{l.codigo}</div>
                                                    <div className="text-xs text-red-600">Aguardando na base <strong>{l.baseSegmento}</strong> há {((now - l.timestampCriacao)/3600000).toFixed(1)}h</div>
                                                </div>
                                                <button onClick={()=>mudarStatus(l.id,'impressao')} className="bg-red-600 text-white px-4 py-2 rounded font-bold text-xs shadow-md uppercase hover:bg-red-700 transition">Baixar Agora</button>
                                            </div>
                                        ))}</div>
                                    ) : <div className="text-center p-12 text-gray-400">Nenhum lote com atraso crítico.</div>}
                                </div>
                            </div>
                        )}

                        {activeTab === 'relatorio' && (
                            <div className="bg-white rounded-xl shadow border border-gray-200 overflow-hidden">
                                <div className="p-4 bg-gray-50 border-b flex flex-col md:flex-row justify-between items-center gap-4">
                                    <h2 className="font-bold text-gray-700 flex gap-2 items-center uppercase text-sm"><Icons.FileText className="w-5 h-5"/> Relatório Geral</h2>
                                    <div className="flex gap-2 no-print">
                                        <button onClick={exportarCSV} className="bg-gray-600 text-white px-3 py-1 rounded text-xs font-bold flex gap-1 items-center hover:bg-gray-700 transition">
                                            <Icons.FileText className="w-3 h-3"/> CSV
                                        </button>
                                        <button onClick={exportarExcel} className="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold flex gap-1 items-center hover:bg-green-700 transition">
                                            <Icons.List className="w-3 h-3"/> Excel
                                        </button>
                                        <button onClick={exportarPDF} className="bg-red-600 text-white px-3 py-1 rounded text-xs font-bold flex gap-1 items-center hover:bg-red-700 transition">
                                            <Icons.Download className="w-3 h-3"/> PDF
                                        </button>
                                        <button onClick={() => window.print()} className="bg-slate-700 text-white px-3 py-1 rounded text-xs font-bold flex gap-1 items-center hover:bg-slate-800 transition">
                                            <Icons.Printer className="w-3 h-3"/> Imprimir
                                        </button>
                                    </div>
                                </div>
                                <div className="p-4 border-b space-y-2 no-print">
                                    <div className="grid grid-cols-2 md:grid-cols-5 gap-2">
                                        <input value={filtroTexto} onChange={e=>setFiltroTexto(e.target.value)} className="border p-2 rounded text-xs focus:outline-none" placeholder="Lote..."/>
                                        <select value={filtroBase} onChange={e=>setFiltroBase(e.target.value)} className="border p-2 rounded text-xs focus:outline-none"><option value="">Todas Bases</option>{listaBases.map(b=><option key={b} value={b}>{b}</option>)}</select>
                                        <input type="date" value={dataInicio} onChange={e=>setDataInicio(e.target.value)} className="border p-2 rounded text-xs focus:outline-none" />
                                        <input type="date" value={dataFim} onChange={e=>setDataFim(e.target.value)} className="border p-2 rounded text-xs focus:outline-none" />
                                        <select value={filtroStatus} onChange={e=>setFiltroStatus(e.target.value)} className="border p-2 rounded text-xs focus:outline-none"><option value="todos">Todos Status</option><option value="pendente">Pendente</option><option value="impressao">Processado</option></select>
                                    </div>
                                    <div className="flex gap-4 items-center pt-2">
                                        <div className="bg-white border px-3 py-1 rounded text-xs font-bold text-gray-600 uppercase">Total Geral <span className="text-black ml-1 font-black">{lotes.length}</span></div>
                                        <div className="bg-blue-50 border border-blue-100 px-3 py-1 rounded text-xs font-bold text-blue-700 uppercase tracking-tighter shadow-sm">Exibindo <span className="text-blue-900 ml-1 font-black">{lotesFiltradosRelatorio.length}</span></div>
                                    </div>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-[10px] text-left">
                                        <thead className="bg-gray-100 border-b font-bold text-gray-600 uppercase tracking-wider">
                                            <tr><th className="p-3">Data</th><th className="p-3">Lote</th><th className="p-3">Base</th><th className="p-3">Status</th><th className="p-3">Período</th><th className="p-3 text-right">Opções</th></tr>
                                        </thead>
                                        <tbody className="divide-y">{lotesFiltradosRelatorio.map(l=>(<tr key={l.id} className="hover:bg-gray-50"><td className="p-3">{l.dataCriacao}</td><td className="p-3 font-bold font-mono text-xs uppercase">{l.codigo}</td><td className="p-3 uppercase text-gray-600">{l.baseSegmento}</td><td className="p-3 uppercase font-bold text-indigo-700">{l.status}</td><td className="p-3 uppercase text-gray-500 font-bold">{l.periodo}</td><td className="p-3 text-right"><button onClick={()=>removerLote(l.id)} className="text-red-300 hover:text-red-500 transition"><Icons.Trash2 className="w-4 h-4"/></button></td></tr>))}</tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'consulta' && (
                            <div className="max-w-xl mx-auto space-y-6">
                                <div className="bg-white p-8 rounded-xl shadow border border-gray-200 text-center">
                                    <h2 className="text-xl font-bold mb-4 text-gray-700 flex gap-2 justify-center items-center uppercase"><Icons.Search className="text-indigo-600"/> Consultar Lote</h2>
                                    <input value={consultaTermo} onChange={e=>setConsultaTermo(e.target.value)} className="w-full p-4 border-2 rounded-xl text-center font-mono font-bold text-2xl uppercase bg-gray-50 focus:border-indigo-500 focus:outline-none transition-all shadow-inner" placeholder="BIPAR CÓDIGO..." autoFocus />
                                </div>
                                <div className="space-y-4">
                                    {lotes.filter(l => l.codigo.includes(consultaTermo.toUpperCase()) && consultaTermo).map(l=>(
                                        <div key={l.id} className="p-6 border rounded-xl bg-white shadow-md border-indigo-100 animate-in fade-in zoom-in duration-300">
                                            <div className="flex justify-between items-start border-b pb-4 mb-4">
                                                <div>
                                                    <span className="text-[10px] text-gray-400 font-bold uppercase block mb-1">Lote</span>
                                                    <div className="text-3xl font-black text-slate-800 font-mono tracking-tighter uppercase">{l.codigo}</div>
                                                </div>
                                                <div className={`px-4 py-1 rounded-full text-[10px] font-bold text-white uppercase shadow-sm ${l.status==='pendente'?'bg-orange-500':'bg-green-600'}`}>{l.status}</div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-y-4 text-xs">
                                                <div><span className="text-[10px] text-gray-400 font-bold uppercase block mb-1">Base / Segmento</span><div className="font-bold text-slate-700 uppercase">{l.baseSegmento}</div></div>
                                                <div><span className="text-[10px] text-gray-400 font-bold uppercase block mb-1">Data de Criação</span><div className="font-bold text-slate-700">{l.dataCriacao} às {l.horaCriacao}</div></div>
                                                <div><span className="text-[10px] text-gray-400 font-bold uppercase block mb-1">Período</span><div className="font-bold text-indigo-600 uppercase">{l.periodo}</div></div>
                                            </div>
                                            <div className="mt-6 pt-4 border-t">
                                                <div className="text-[10px] text-gray-400 font-bold uppercase mb-3">Histórico de Eventos</div>
                                                <div className="space-y-2">
                                                    {(l.historico || []).map((h, i) => (
                                                        <div key={i} className="flex gap-3 text-[10px] items-center">
                                                            <span className="text-gray-400 font-mono">{h.data}</span>
                                                            <span className="font-black uppercase tracking-tight text-slate-600">{h.status}</span>
                                                            <span className="text-gray-500 italic">- {h.detalhe}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    <div id="area-impressao-etiquetas" className="hidden">
                        {lotesParaImprimir.map(l=>{
                            const p = l.baseSegmento.split('—');
                            return (<div key={l.id} className="label-card"><div className="label-header"><div><span className="header-title">SEGMENTO</span><div className="header-value">{p[0]||'GERAL'}</div></div><div><span className="header-title">BASE</span><div className="header-value">{p[1]||l.baseSegmento}</div></div></div><div className="label-content"><div style={{width:'80px',height:'80px'}}><QRCodeImage text={l.codigo} size={80}/></div><div className="label-text">{l.codigo}</div></div><div className="label-footer"><div className="footer-title">EXPEDIÇÃO</div><div className="check-item"><span className="check-box"></span> CONFERIDO</div><div className="footer-inputs"><span>{l.dataCriacao}</span><span>{l.horaCriacao}</span></div></div></div>)
                        })}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
